# Анализ проекта Branchy — рекомендации по улучшению

Краткий разбор структуры, рисков и конкретных улучшений. Местами цинично.

---

## Что уже хорошо

- **README** — подробный, с примерами Docker, API и синтаксисом. Реально можно работать по нему.
- **Rust**: линты Clippy включены (branches, correctness, perf и т.д.), тесты в `tests/` и в модулях, единый `lib.rs` с явным публичным API.
- **Фронт**: TypeScript со `strict: true`, Monaco с подсветкой своего DSL, разделение типов ответов (RunOk/RunErr, trace/error).
- **Docker Compose**: один образ для тестов/run/compile, кэш cargo/target в volumes, отдельные сервисы gateway/web/coverage.
- **PowerShell**: скрипты без кириллицы, `$ErrorActionPreference = "Stop"`, нормальный вывод и коды выхода.

---

## Критичное: gateway и бэкенд

**Проблема:** В `nginx/nginx.conf.template` указано:

```nginx
location /api/ {
    proxy_pass http://$backend;
    ...
}
```

Без **trailing slash** в `proxy_pass` nginx передаёт бэкенду **полный** URI: `/api/run`, `/api/format` и т.д. Бэкенд же вешает маршруты на `/run`, `/format`, `/health`, `/examples` — префикса `/api` нет. В итоге за запросом на `http://localhost:8081/api/run` бэкенд получает путь `/api/run` и отдаёт **404**.

**Исправление:** сбрасывать префикс при проксировании:

```nginx
location /api/ {
    proxy_pass http://$backend/;   # trailing slash — /api/run -> http://backend/run
    proxy_http_version 1.1;
    ...
}
```

Либо завести в Axum префикс: `Router::new().nest("/api", routes)` и тогда оставить `proxy_pass` без слэша. Сейчас конфиг и код друг другу не соответствуют.

---

## Безопасность и продакшен

1. **CORS:** `CorsLayer::permissive()` в `src/server/mod.rs` открывает всё с любого origin. Для публичного API лучше ограничить `AllowedOrigin` (например, по списку доменов или хотя бы по схеме/хосту фронта).
2. **Размер тела запроса:** лимита на `source` в `/api/run` и `/api/format` нет — можно слать гигабайты и добивать парсер/память. Имеет смысл добавить middleware ограничения размера тела (например, `tower_http::limit::RequestBodyLimitLayer`) или проверку `body.source.len()` на разумный предел (например, 1–2 MiB).
3. **Рейт-лимит:** для публичного инстанса не помешает простой rate limit на `/api/run` и `/api/format`, чтобы не разнесли сервер тяжёлыми скриптами.

---

## Инфраструктура и окружение

1. **Rust 1.85:** в `docker-compose.yml` и `Dockerfile.backend` указан `rust:1.85-*`. На момент анализа 1.85 уже стабилен — ок. Стоит зафиксировать в README минимальную версию (1.85) и при необходимости добавить `rust-toolchain.toml`.
2. **Запуск через `app`:** `entrypoint` для сервиса `app` каждый раз гоняет `cargo test && cargo run -- "$@"`. Для разовых `run`/`compile` это сильно тормозит. Имеет смысл вынести тесты в отдельный шаг/сервис и для `app` оставить только `cargo run`, либо завести отдельный сервис `app-notest` без тестов для быстрого запуска.
3. **Dockerfile.backend:** образ `rust:1.85-alpine` для билда — ок. В `docker-compose` для `web` используется `rust:1.85-bookworm` без отдельного билд-образа, поэтому при каждом `up` всё пересобирается в контейнере. Для ускорения можно собирать бинарник в multi-stage (как в Dockerfile.backend) и в compose использовать уже собранный образ.

---

## Фронтенд

1. **Нет автотестов:** в `frontend/` нет ни unit (Vitest/Jest), ни e2e. Хоть бы smoke: загрузка, выбор примера, Run, Format и проверка ответа/ошибки — уже снизит риск поломки при рефакторинге.
2. **Vite proxy:** в `vite.config.ts` для dev задано `rewrite: (path) => path.replace(/^\/api/, '')` — запросы уходят на `http://localhost:3000/run` и т.д. Это согласовано с бэкендом (маршруты без `/api`). При использовании только gateway (порт 8081) проблемы нет; при dev с `npm run dev` и отдельным бэкендом — всё ок.
3. **Внешний вид:** интерфейс читаемый, тёмная тема, подсветка ошибок и trace в редакторе. Можно усилить: явная доступность (aria-labels уже частично есть), сброс подсветки при смене примера, индикация «нет соединения с API» при падении запроса.

---

## Документация и репозиторий

1. **.cursor/plans:** в репо лежат планы (например, `branchy_formatter_4872d914.plan.md`). Если это личные артефакты Cursor, их лучше добавить в `.gitignore`, чтобы не засорять историю.
2. **LICENSE:** в корне нет файла LICENSE — при открытой публикации непонятны условия использования.
3. **CONTRIBUTING:** при приёме контрибуций полезен короткий CONTRIBUTING.md: как запускать тесты, форматтер, что проверять перед PR (например, `check-format.ps1`, `docker-compose run --rm test`).

---

## Мелкие улучшения

- **Форматтер:** в README сказано «комментарии не предусмотрены» — если когда-нибудь появятся, парсер и форматтер нужно будет явно учитывать.
- **Примеры:** в таблице примеров есть `vars.branchy`, в списке файлов из grep он есть — но в таблице README не описан. Имеет смысл либо добавить строку в таблицу, либо убрать файл из примеров.
- **Fuzz:** есть `scripts/fuzz_examples.sh` (прогон примеров несколько раз). Для более жёсткого фаззинга можно подключить cargo-fuzz по парсеру/лексеру и положить копус из `examples/*.branchy`.
- **Бинарный формат:** версионирование формата `.branchyc` (magic + version) упростит обратную совместимость при изменениях в будущем.

---

## Приоритеты

| Приоритет | Действие |
|-----------|----------|
| Высокий   | Починить nginx `proxy_pass` (trailing slash или nest `/api` в Axum). |
| Высокий   | Ограничить размер тела запроса к `/api/run` и `/api/format`. |
| Средний   | Сузить CORS для не-локальной среды. |
| Средний   | Ускорить dev: не гонять тесты при каждом `docker-compose run --rm app run ...`. |
| Низкий    | Добавить LICENSE, при желании CONTRIBUTING и вынести `.cursor` в gitignore. |
| Низкий    | Минимальные автотесты на фронте (smoke). |

Если хочешь, могу предложить конкретные патчи (diff) по nginx и по ограничению размера тела в Axum.
